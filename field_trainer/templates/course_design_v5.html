{% extends "base.html" %}
{% block title %}Course Design - Field Trainer{% endblock %}

{% block head %}
<!-- UPDATED: 2025-11-02 15:05 - Fixed media query breakpoints to 480px -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
{% endblock %}

{% block extra_css %}
<style>
    body { padding-bottom: 100px; }

    /* Form Grid */
    .top-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }

    .bottom-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
    }

    @media (max-width: 768px) {
        .top-row { grid-template-columns: 1fr; }
    }

    /* Section Cards */
    .section-card {
        margin-bottom: 12px;
    }

    .section-card .card-header {
        background-color: #0d6efd;
        color: white;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }

    .section-card .card-header:hover {
        background-color: #0b5ed7;
    }

    .section-card .card-header.complete {
        background-color: #198754;
    }

    .section-card .card-header.complete:hover {
        background-color: #157347;
    }

    .section-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-number {
        background: rgba(255,255,255,0.2);
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.3rem;
        border: 2px solid rgba(255,255,255,0.5);
    }
    
    .accordion-info { flex: 1; }
    
    .accordion-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .accordion-subtitle {
        font-size: 0.9rem;
        opacity: 0.95;
    }
    
    .accordion-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .accordion-check {
        font-size: 1.5rem;
        animation: checkPop 0.3s ease;
    }
    
    @keyframes checkPop {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    .accordion-arrow {
        font-size: 1.4rem;
        transition: transform 0.3s;
    }

    .section-card .accordion-arrow {
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        transition: transform 0.2s ease;
    }

    .section-card.expanded .accordion-arrow { transform: rotate(180deg); }

    /* Card Body Toggle */
    .section-card .card-body.accordion-body {
        padding: 0.75rem;
    }
    
    /* Device List */
    .devices-list {
        display: grid;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    /* Device Card */
    .device-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 12px;
        transition: all 0.2s;
    }

    .device-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .device-card.start {
        border-color: #198754;
        background: #f8f9fa;
    }
    
    .device-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .device-label {
        font-size: 1rem;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .device-badge {
        background: #0d6efd;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .device-badge.start {
        background: #198754;
    }
    
    /* Device Fields Grid - ALL SIDE BY SIDE */
    .device-grid {
        display: grid;
        grid-template-columns: 2fr 2fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
    }

    .device-grid-full { grid-column: 1 / -1; }

    @media (max-width: 480px) {
        .device-grid { grid-template-columns: 1fr; }
    }
    
    /* Form Controls */
    .form-group { margin: 0; }
    
    label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .form-control, .form-select {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid #ced4da;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s;
        background: white;
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.25);
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 60px;
        font-family: inherit;
    }
    
    /* Override Bootstrap button styles slightly */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-block {
        width: 100%;
        justify-content: center;
    }
    
    .btn-sm {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
    
    /* Sticky Footer */
    .sticky-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 3px solid #667eea;
        padding: 16px 20px;
        box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
        z-index: 1000;
        display: flex;
        justify-content: center;
        gap: 16px;
    }
    
    .sticky-footer .btn {
        min-width: 160px;
        padding: 16px 32px;
        font-size: 1.1rem;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 20px 15px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 6px;
        border: 2px dashed #dee2e6;
    }

    .empty-icon {
        font-size: 1.8rem;
        margin-bottom: 6px;
        opacity: 0.6;
    }

    .empty-text {
        font-size: 0.85rem;
        margin: 0;
    }

    /* Per-Device Advanced Settings */
    .advanced-fields {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 2px dashed #dee2e6;
    }

    .advanced-fields-header {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        user-select: none;
    }

    .advanced-fields-header:hover {
        color: #495057;
    }

    .advanced-toggle-icon {
        transition: transform 0.2s;
    }

    .advanced-fields.expanded .advanced-toggle-icon {
        transform: rotate(90deg);
    }

    .advanced-grid {
        display: none;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 8px;
    }

    .advanced-fields.expanded .advanced-grid {
        display: grid;
    }

    /* Tooltip styles */
    .field-label-with-tooltip {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background: #6c757d;
        color: white;
        border-radius: 50%;
        font-size: 11px;
        font-weight: bold;
        cursor: help;
    }

    .tooltip-icon:hover {
        background: #495057;
    }

    /* Compact card spacing */
    .card-body {
        padding: 0.75rem;
    }

    .card-header {
        padding: 0.5rem 0.75rem;
    }

    .card-header h5 {
        font-size: 1rem;
    }

    .card-header small {
        font-size: 0.8rem;
    }

    .form-group {
        margin-bottom: 0.4rem;
    }

    /* Compact form controls */
    .form-control, .form-select {
        padding: 0.3rem 0.6rem;
        font-size: 0.875rem;
        height: calc(1.5em + 0.6rem + 2px);
    }

    textarea.form-control {
        height: auto;
        min-height: 2.2rem;
        padding: 0.4rem 0.6rem;
    }

    label {
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
        font-weight: 500;
    }

    .card {
        margin-bottom: 0.75rem !important;
    }

    /* Compact buttons */
    .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
    }

    .btn-block {
        padding: 0.5rem 1rem;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
        .top-bar { padding: 16px; }
        .top-bar h2 { font-size: 1.5rem; margin-bottom: 16px; }

        .course-accordion { padding: 0 12px 12px; }

        .accordion-header { padding: 14px 16px; }
        .accordion-title { font-size: 1.1rem; }
        .accordion-number { width: 36px; height: 36px; font-size: 1.1rem; }

        .accordion-body { padding: 0 16px; }
        .accordion-section.expanded .accordion-body { padding: 16px; }

        .device-card { padding: 16px; }

        .sticky-footer {
            flex-direction: column;
            padding: 12px;
        }

        .sticky-footer .btn {
            width: 100%;
            min-width: auto;
        }

        body { padding-bottom: 180px; }

        .section-divider { height: 6px; margin: 24px 0; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        {% if mode == 'edit' %}
            <i class="bi bi-pencil-square"></i> Edit Course
        {% elif mode == 'duplicate' %}
            <i class="bi bi-files"></i> Duplicate Course
        {% else %}
            <i class="bi bi-plus-circle"></i> Create New Course
        {% endif %}
    </h1>
    <a href="/courses" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back
    </a>
</div>

<!-- Course Details Card -->
<div class="card section-card mb-3 expanded" id="section-0">
    <div class="card-header" onclick="toggleSection(0)">
        <div class="section-header-left">
            <div>
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Course Details</h5>
            </div>
        </div>
        <div>
            <span class="accordion-arrow">‚ñº</span>
        </div>
    </div>
    <div class="card-body accordion-body" style="display:block;">
        <div class="top-row">
        <div class="form-group">
            <label for="courseName">Course Name *</label>
            <input type="text" class="form-control" id="courseName" placeholder="e.g., Speed Circuit">
        </div>
        <div class="form-group">
            <label for="courseCategory">Category</label>
            <select class="form-select" id="courseCategory">
                <option value="agility">Agility</option>
                <option value="conditioning">Conditioning</option>
                <option value="endurance">Endurance</option>
                <option value="plyometrics">Plyometrics</option>
                <option value="reaction">Reaction</option>
                <option value="recovery">Recovery</option>
                <option value="speed">Speed</option>
                <option value="strength">Strength</option>
                <option value="stress">Stress</option>
                <option value="warmup">Warm-up</option>
            </select>
        </div>
        <div class="form-group">
            <label for="distanceUnit">Distance Unit</label>
            <select class="form-select" id="distanceUnit" onchange="updateDistanceLabels()">
                <option value="yards">Yards</option>
                <option value="meters">Meters</option>
                <option value="feet">Feet</option>
            </select>
        </div>
    </div>

        <div class="bottom-row">
            <div class="form-group">
                <label for="courseDescription">Description</label>
                <input type="text" class="form-control" id="courseDescription" placeholder="Brief description...">
            </div>
        </div>
    </div>
</div>

<!-- Devices & Actions Card -->
<div class="card section-card mb-3 expanded" id="section-1">
    <div class="card-header" onclick="toggleSection(1)">
        <div class="section-header-left">
            <div>
                <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Devices & Actions</h5>
                <small>Configure your course sequence</small>
            </div>
        </div>
        <div>
            <span class="accordion-arrow">‚ñº</span>
        </div>
    </div>
    <div class="card-body accordion-body" style="display:block;">
            <div class="devices-list" id="devicesList"></div>
            <button type="button" class="btn btn-primary btn-block" onclick="addDevice()">
                ‚ûï Add Device
            </button>
    </div>
</div>

<!-- Interactive Diagram Card -->
<div class="card section-card mb-3 expanded" id="section-2">
    <div class="card-header" onclick="toggleSection(2)">
        <div class="section-header-left">
            <div>
                <h5 class="mb-0"><i class="bi bi-diagram-2"></i> Interactive Diagram</h5>
                <small>Visualize and arrange your course layout</small>
            </div>
        </div>
        <div>
            <span class="accordion-check" style="display:none;">‚úì</span>
            <span class="accordion-arrow">‚ñº</span>
        </div>
    </div>
    <div class="card-body accordion-body" style="display:block;">
            <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                <button type="button" class="btn btn-primary" onclick="generateDiagram()">
                    üîÑ Generate Diagram
                </button>
                <button type="button" class="btn btn-secondary" onclick="toggleRotateMode()">
                    <span id="rotateModeLabel">‚Üª Rotate Mode: OFF</span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="toggleShowDistance()">
                    <span id="showDistanceLabel">üìè Show: Distance</span>
                </button>
            </div>
            <div id="diagramPreview" style="min-height: 250px; border: 2px solid #dee2e6; border-radius: 6px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                <div class="empty-state">
                    <div class="empty-icon">üìç</div>
                    <p class="empty-text">Add devices and click "Generate Diagram"</p>
                </div>
            </div>
        </div>
    </div>

    <hr class="section-divider">

    <!-- Section 3: Layout Instructions -->
    <div class="accordion-section" id="section-3">
        <div class="accordion-header" onclick="toggleSection(3)">
            <div class="accordion-left">
                <div class="accordion-info">
                    <div class="accordion-title">Layout Instructions</div>
                    <div class="accordion-subtitle">How to arrange cones on the field (optional)</div>
                </div>
            </div>
            <div class="accordion-right">
                <span class="accordion-check" style="display:none;">‚úì</span>
                <span class="accordion-arrow">‚ñº</span>
            </div>
        </div>
        <div class="accordion-body">
            <div class="form-group">
                <label for="courseInstruction">Setup Instructions</label>
                <textarea class="form-control" id="courseInstruction" placeholder="e.g., Place cones in a straight line 30 yards apart..." rows="4"></textarea>
            </div>
        </div>
    </div>

    <hr class="section-divider">

    <!-- Section 4: Advanced Settings -->
    <div class="accordion-section" id="section-4">
        <div class="accordion-header" onclick="toggleSection(4)">
            <div class="accordion-left">
                <div class="accordion-info">
                    <div class="accordion-title">Advanced Settings</div>
                    <div class="accordion-subtitle">Custom drill behaviors and pattern modes (optional)</div>
                </div>
            </div>
            <div class="accordion-right">
                <span class="accordion-check" style="display:none;">‚úì</span>
                <span class="accordion-arrow">‚ñº</span>
            </div>
        </div>
        <div class="accordion-body">
            <!-- Course Mode -->
            <div class="form-group">
                <label for="courseMode">
                    <strong>Course Mode</strong>
                    <small class="text-muted d-block">How athletes progress through the course</small>
                </label>
                <select class="form-control" id="courseModeSelect" onchange="updateModeDescription()">
                    <option value="sequential">Sequential (Standard) - Athletes follow devices in order</option>
                    <option value="pattern">Pattern-Based - Custom drill rules (e.g., Simon Says)</option>
                </select>
            </div>

            <!-- Mode Description -->
            <div class="alert alert-info" id="modeDescription" style="margin-top: 12px;">
                <strong>Sequential Mode:</strong> Athletes touch devices in the defined order (1 ‚Üí 2 ‚Üí 3...). This is the standard mode for most drills.
            </div>

            <!-- Behavior Config (shown for pattern mode) -->
            <div id="behaviorConfigSection" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label for="behaviorConfig">
                        <strong>Custom Behavior Configuration</strong>
                        <small class="text-muted d-block">JSON format - defines custom drill rules</small>
                    </label>
                    <textarea class="form-control" id="behaviorConfig" rows="8" placeholder='Example for Simon Says:
{
  "allowed_colors": ["red", "green", "blue", "yellow"],
  "pattern_length": 4,
  "show_pattern_duration": 3,
  "allow_repeats": false
}'></textarea>
                    <small class="form-text text-muted">
                        <strong>Common configurations:</strong><br>
                        ‚Ä¢ <code>allowed_colors</code>: Array of colors for pattern drills<br>
                        ‚Ä¢ <code>pattern_length</code>: Number of steps in pattern<br>
                        ‚Ä¢ <code>show_pattern_duration</code>: Seconds to display pattern<br>
                        ‚Ä¢ <code>allow_repeats</code>: Can same color appear twice in a row
                    </small>
                </div>

                <!-- Validation Status -->
                <div id="jsonValidation" style="display: none; padding: 10px; border-radius: 6px; margin-top: 8px;">
                    <small><span id="jsonValidationText"></span></small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sticky Footer -->
<div class="sticky-footer">
    <button type="button" class="btn btn-secondary" onclick="window.location.href='/courses'">
        ‚úñÔ∏è Cancel
    </button>
    <button type="button" class="btn btn-success" onclick="saveCourse()">
        üíæ Save Course
    </button>
</div>

<script>
const DEBUG = true;
const courseData = {{ course | tojson | safe if course else 'null' }};
const courseMode = '{{ mode }}';
let devices = [];
let availableDevices = [];
let usedDevices = new Set();

// Diagram variables
let courseDiagram = '';
let conePositions = [];
let rotateMode = false;
let showActions = false;
let dragState = null;
let svgElement = null;

// Action descriptions - default instructions for each action type
const actionDescriptions = {
    'bounds': 'Push off forcefully from one leg and extend the opposite leg forward in a long, exaggerated stride. Land softly and repeat with rhythm and control.',
    'butt_kicks': 'Jog forward while driving heels up toward the glutes. Keep knees low and maintain a steady cadence.',
    'carioca_left': 'Cross one leg over the other while moving laterally, rotating hips with each step. Stay light on your feet and maintain fluid motion.',
    'carioca_right': 'Cross one leg over the other while moving laterally, rotating hips with each step. Stay light on your feet and maintain fluid motion.',
    'external_hip': 'Lift the knee and rotate the leg outward in a circular motion. Engage hip muscles and maintain balance throughout.',
    'high_knees': 'Drive knees up toward the chest with each step while staying tall. Use fast, rhythmic arm swings to match leg speed.',
    'high_skips': 'Skip forward with exaggerated vertical lift and arm drive. Focus on height, rhythm, and soft landings.',
    'icky_shuffle': 'Step quickly in and out of an agility ladder with alternating feet. Stay low and maintain fast, precise footwork.',
    'internal_hip': 'Lift the knee and rotate the leg inward across the body. Keep core engaged and movement controlled.',
    'jog': 'Run at a light, steady pace with relaxed arms and even strides. Maintain upright posture and breathing rhythm.',
    'ladder': 'Perform quick foot patterns through each box of the ladder. Stay light, fast, and coordinated.',
    'side_shuffle_left': 'Move laterally by pushing off the trailing foot and keeping feet shoulder-width apart. Stay low and avoid crossing feet.',
    'side_shuffle_right': 'Move laterally by pushing off the trailing foot and keeping feet shoulder-width apart. Stay low and avoid crossing feet.',
    'sprint': 'Explode forward from a low stance using powerful leg drive. Maintain forward lean and maximum effort over short distance.',
    'two_in_two_out': 'Step both feet into and out of each ladder box in a quick, rhythmic pattern. Focus on speed, timing, and control.',
    'walking_lunge': 'Step forward into a deep lunge, lowering the rear knee toward the ground. Push off the front foot to rise and repeat with the opposite leg.'
};

console.log('üé® ACCORDION v5 LOADED - Final layout with diagram support');

// Initialize from existing data
if (courseData && (courseMode === 'edit' || courseMode === 'duplicate')) {
    if (courseData.course_name) document.getElementById('courseName').value = courseData.course_name;
    if (courseData.description) document.getElementById('courseDescription').value = courseData.description;
    if (courseData.category) document.getElementById('courseCategory').value = courseData.category;
    if (courseData.layout_instructions) document.getElementById('courseInstruction').value = courseData.layout_instructions;
    if (courseData.distance_unit) document.getElementById('distanceUnit').value = courseData.distance_unit;

    // Load advanced settings
    if (courseData.mode) {
        document.getElementById('courseModeSelect').value = courseData.mode;
        updateModeDescription();
    }

    // Load behavior_config if present (from first action that has it)
    if (courseData.actions && courseData.actions.length > 0) {
        const actionWithConfig = courseData.actions.find(a => a.behavior_config);
        if (actionWithConfig && actionWithConfig.behavior_config) {
            try {
                const config = typeof actionWithConfig.behavior_config === 'string'
                    ? JSON.parse(actionWithConfig.behavior_config)
                    : actionWithConfig.behavior_config;
                document.getElementById('behaviorConfig').value = JSON.stringify(config, null, 2);
                validateJSON();
            } catch (e) {
                console.error('Error loading behavior config:', e);
            }
        }
    }

    if (courseData.actions && courseData.actions.length > 0) {
        devices = courseData.actions.map(a => {
            const action = a.action || 'default_beep';
            // Auto-populate instruction if blank using default description for this action
            const instruction = a.instruction || actionDescriptions[action] || '';
            return {
                device_id: a.device_id,
                device_name: a.device_name || a.device_id,
                action: action,
                instruction: instruction,
                distance: a.distance || 0,
                device_function: a.device_function || '',
                detection_method: a.detection_method || '',
                group_identifier: a.group_identifier || '',
                behavior_config: a.behavior_config || ''
            };
        });
        devices.forEach(d => usedDevices.add(d.device_id));
    }

    // Restore diagram if available
    if (courseData.diagram_svg) {
        courseDiagram = courseData.diagram_svg;
        document.getElementById('diagramPreview').innerHTML = courseDiagram;

        // Extract cone positions from SVG comment
        const posMatch = courseDiagram.match(/<!-- CONE_POSITIONS:(.*?) -->/);
        if (posMatch && posMatch[1]) {
            try {
                conePositions = JSON.parse(posMatch[1]);
                console.log('Restored cone positions from diagram:', conePositions);
            } catch (e) {
                console.warn('Failed to parse cone positions:', e);
            }
        }

        // Set up interactivity (drag/rotate)
        // Use setTimeout to ensure DOM is ready
        setTimeout(() => {
            setupDragging();
        }, 100);
    }
}

function toggleSection(num) {
    const section = document.getElementById(`section-${num}`);
    const body = section.querySelector('.card-body');
    const isExpanded = section.classList.contains('expanded');

    if (isExpanded) {
        section.classList.remove('expanded');
        body.style.display = 'none';
    } else {
        section.classList.add('expanded');
        body.style.display = 'block';
        if (num === 1 && availableDevices.length === 0) {
            loadAvailableDevices();
        }
    }
}

function markComplete(num, complete) {
    const section = document.getElementById(`section-${num}`);
    if (!section) return;

    const check = section.querySelector('.accordion-check');
    const header = section.querySelector('.card-header');

    if (header) {
        if (complete) {
            header.classList.add('complete');
            if (check) check.style.display = 'inline';
        } else {
            header.classList.remove('complete');
            if (check) check.style.display = 'none';
        }
    }
}

async function loadAvailableDevices() {
    try {
        const res = await fetch('/api/devices/available');
        const data = await res.json();
        if (data.success) {
            availableDevices = data.devices;
            console.log('Loaded devices:', availableDevices.length);
            renderDevices();
        }
    } catch (e) {
        console.error('Failed to load devices:', e);
    }
}

function getDistanceUnitLabel() {
    const unit = document.getElementById('distanceUnit')?.value || 'yards';
    return unit.charAt(0).toUpperCase() + unit.slice(1);
}

function updateDistanceLabels() {
    const labels = document.querySelectorAll('.distance-label');
    const unitLabel = getDistanceUnitLabel();
    labels.forEach(label => {
        label.textContent = `Distance (${unitLabel})`;
    });
}

function renderDevices() {
    const container = document.getElementById('devicesList');
    
    if (devices.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div><p class="empty-text">No devices added yet. Click "Add Device" to begin.</p></div>';
        return;
    }

    container.innerHTML = '';
    devices.forEach((dev, idx) => {
        const card = createDeviceCard(dev, idx);
        container.appendChild(card);
    });
}

function createDeviceCard(dev, idx) {
    const isStart = idx === 0;
    const card = document.createElement('div');
    card.className = 'device-card' + (isStart ? ' start' : '');
    
    const deviceOpts = availableDevices
        .filter(d => !usedDevices.has(d.device_id) || d.device_id === dev.device_id)
        .map(d => `<option value="${d.device_id}" ${d.device_id === dev.device_id ? 'selected' : ''}>${d.display_name} ${d.online ? '' : '(offline)'}</option>`)
        .join('');
    
    const actionOpts = `
        <option value="default_beep" ${dev.action === 'default_beep' ? 'selected' : ''}>Beep</option>
        <option value="backpedal" ${dev.action === 'backpedal' ? 'selected' : ''}>Backpedal</option>
        <option value="bounds" ${dev.action === 'bounds' ? 'selected' : ''}>Bounds</option>
        <option value="butt_kicks" ${dev.action === 'butt_kicks' ? 'selected' : ''}>Butt Kicks</option>
        <option value="carioca_left" ${dev.action === 'carioca_left' ? 'selected' : ''}>Carioca Left</option>
        <option value="carioca_right" ${dev.action === 'carioca_right' ? 'selected' : ''}>Carioca Right</option>
        <option value="external_hip" ${dev.action === 'external_hip' ? 'selected' : ''}>External Hip</option>
        <option value="high_knees" ${dev.action === 'high_knees' ? 'selected' : ''}>High Knees</option>
        <option value="high_skips" ${dev.action === 'high_skips' ? 'selected' : ''}>High Skips</option>
        <option value="icky_shuffle" ${dev.action === 'icky_shuffle' ? 'selected' : ''}>Icky Shuffle</option>
        <option value="internal_hip" ${dev.action === 'internal_hip' ? 'selected' : ''}>Internal Hip</option>
        <option value="jog" ${dev.action === 'jog' ? 'selected' : ''}>Jog</option>
        <option value="ladder" ${dev.action === 'ladder' ? 'selected' : ''}>Ladder</option>
        <option value="side_shuffle_left" ${dev.action === 'side_shuffle_left' ? 'selected' : ''}>Side Shuffle Left</option>
        <option value="side_shuffle_right" ${dev.action === 'side_shuffle_right' ? 'selected' : ''}>Side Shuffle Right</option>
        <option value="sprint" ${dev.action === 'sprint' ? 'selected' : ''}>Sprint</option>
        <option value="two_in_two_out" ${dev.action === 'two_in_two_out' ? 'selected' : ''}>Two In Two Out</option>
        <option value="walking_lunge" ${dev.action === 'walking_lunge' ? 'selected' : ''}>Walking Lunge</option>
    `;

    const deviceFunctionOpts = `
        <option value="" ${!dev.device_function ? 'selected' : ''}>-- Not Set --</option>
        <option value="start_finish" ${dev.device_function === 'start_finish' ? 'selected' : ''}>Start/Finish</option>
        <option value="waypoint" ${dev.device_function === 'waypoint' ? 'selected' : ''}>Waypoint</option>
        <option value="turnaround" ${dev.device_function === 'turnaround' ? 'selected' : ''}>Turnaround</option>
        <option value="boundary" ${dev.device_function === 'boundary' ? 'selected' : ''}>Boundary</option>
        <option value="timer" ${dev.device_function === 'timer' ? 'selected' : ''}>Timer</option>
    `;

    const detectionMethodOpts = `
        <option value="" ${!dev.detection_method ? 'selected' : ''}>-- Not Set --</option>
        <option value="touch" ${dev.detection_method === 'touch' ? 'selected' : ''}>Touch</option>
        <option value="proximity" ${dev.detection_method === 'proximity' ? 'selected' : ''}>Proximity</option>
        <option value="none" ${dev.detection_method === 'none' ? 'selected' : ''}>None</option>
    `;

    card.innerHTML = `
        <div class="device-header">
            <div class="device-label">
                ${isStart ? 'üü¢ Start Device' : 'üü† Cone ' + idx}
            </div>
            ${!isStart ? `<button type="button" class="btn btn-danger btn-sm" onclick="removeDevice(${idx})" style="padding: 8px 16px; margin-left: auto;">üóëÔ∏è Remove</button>` : ''}
        </div>
        <div class="device-grid">
            <div class="form-group">
                <label>Device</label>
                <select class="form-select" onchange="updateDevice(${idx}, 'device_id', this.value)">
                    ${deviceOpts}
                </select>
            </div>
            <div class="form-group">
                <label>Action</label>
                <select class="form-select" onchange="updateDeviceAction(${idx}, this.value)">
                    ${actionOpts}
                </select>
            </div>
            <div class="form-group">
                <label class="distance-label">Distance (${getDistanceUnitLabel()})</label>
                <input type="number" class="form-control" value="${dev.distance || 0}" min="0" onchange="updateDevice(${idx}, 'distance', this.value)">
            </div>
            <div class="form-group device-grid-full">
                <label>Description</label>
                <textarea class="form-control" id="instruction-${idx}" rows="2" placeholder="Action description..." onchange="updateDevice(${idx}, 'instruction', this.value)">${dev.instruction || ''}</textarea>
            </div>
        </div>

        <div class="advanced-fields" id="advanced-${idx}">
            <div class="advanced-fields-header" onclick="toggleAdvancedFields(${idx})">
                <span class="advanced-toggle-icon">‚ñ∂</span>
                <span>Advanced Settings (Optional)</span>
            </div>
            <div class="advanced-grid">
                <div class="form-group">
                    <label>Device Function</label>
                    <select class="form-select" onchange="updateDevice(${idx}, 'device_function', this.value)">
                        ${deviceFunctionOpts}
                    </select>
                </div>
                <div class="form-group">
                    <label>Detection Method</label>
                    <select class="form-select" onchange="updateDevice(${idx}, 'detection_method', this.value)">
                        ${detectionMethodOpts}
                    </select>
                </div>
                <div class="form-group">
                    <label class="field-label-with-tooltip">
                        <span>Device Group</span>
                        <span class="tooltip-icon" title="Assign devices to groups (e.g., 'start_line', 'finish_line') to trigger them together or track patterns">?</span>
                    </label>
                    <input type="text" class="form-control" value="${dev.group_identifier || ''}" placeholder="e.g., start_line, finish_line, cone_group_1" onchange="updateDevice(${idx}, 'group_identifier', this.value)">
                </div>
                <div class="form-group">
                    <label class="field-label-with-tooltip">
                        <span>Custom Rules</span>
                        <span class="tooltip-icon" title="Advanced settings for custom behaviors like timing rules, scoring, or special conditions">?</span>
                    </label>
                    <textarea class="form-control" rows="2" placeholder='Example: min_time: 2.5, max_time: 10.0, scoring: true' onchange="updateDevice(${idx}, 'behavior_config', this.value)">${dev.behavior_config || ''}</textarea>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

function toggleAdvancedFields(idx) {
    const section = document.getElementById(`advanced-${idx}`);
    if (section) {
        section.classList.toggle('expanded');
    }
}

function addDevice() {
    if (availableDevices.length === 0) {
        loadAvailableDevices().then(() => addDevice());
        return;
    }
    
    const nextDev = availableDevices.find(d => !usedDevices.has(d.device_id));
    if (!nextDev) {
        alert('All devices are in use');
        return;
    }
    
    devices.push({
        device_id: nextDev.device_id,
        device_name: nextDev.device_name,
        action: 'jog',
        instruction: actionDescriptions['jog'] || '',
        distance: devices.length === 0 ? 0 : 5
    });
    
    usedDevices.add(nextDev.device_id);
    renderDevices();
}

function updateDevice(idx, prop, val) {
    if (prop === 'device_id') {
        usedDevices.delete(devices[idx].device_id);
        usedDevices.add(val);
        const devInfo = availableDevices.find(d => d.device_id === val);
        devices[idx].device_name = devInfo?.device_name || val;
    }

    devices[idx][prop] = prop === 'distance' ? parseFloat(val) || 0 : val;
    console.log(`Updated device ${idx} ${prop}:`, val);
}

function updateDeviceAction(idx, action) {
    // Update the action
    devices[idx].action = action;

    // Auto-populate instruction with default description for this action
    const defaultDescription = actionDescriptions[action] || '';
    devices[idx].instruction = defaultDescription;

    // Update the textarea in the DOM
    const instructionField = document.getElementById(`instruction-${idx}`);
    if (instructionField) {
        instructionField.value = defaultDescription;
    }

    console.log(`Updated device ${idx} action to ${action}, instruction auto-populated`);
}

function removeDevice(idx) {
    if (idx === 0) return;
    if (confirm('Remove this device?')) {
        usedDevices.delete(devices[idx].device_id);
        devices.splice(idx, 1);
        renderDevices();
    }
}

// Diagram functions
function toggleRotateMode() {
    rotateMode = !rotateMode;
    const label = rotateMode ? 'ON' : 'OFF';
    document.getElementById('rotateModeLabel').textContent = '‚Üª Rotate Mode: ' + label;
}

function toggleShowDistance() {
    showActions = !showActions;
    const label = showActions ? 'Actions' : 'Distance';
    document.getElementById('showDistanceLabel').textContent = 'üìè Show: ' + label;
    if (devices.length > 1) generateDiagram();
}

function generateDiagram() {
    console.log('Generating diagram for', devices.length, 'devices');
    if (devices.length < 2) {
        document.getElementById('diagramPreview').innerHTML = '<div class="empty-state"><div class="empty-icon">üìç</div><p class="empty-text">Add at least 2 devices to generate diagram</p></div>';
        return;
    }
    const distanceUnit = document.getElementById('distanceUnit').value || 'yards';
    const width = 800;
    const height = 500;
    const padding = 80;
    if (conePositions.length !== devices.length) {
        conePositions = [];
        const spacing = (width - 2 * padding) / (devices.length - 1);
        devices.forEach((device, idx) => {
            conePositions.push({ x: padding + (idx * spacing), y: height / 2, arrowAngle: 0 });
        });
    }
    let svg = '<svg id="courseSvg" viewBox="0 0 ' + width + ' ' + height + '" xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%; cursor:default;">';
    svg += '<!-- CONE_POSITIONS:' + JSON.stringify(conePositions) + ' -->';
    svg += '<rect width="' + width + '" height="' + height + '" fill="white"/>';
    svg += '<defs><pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">';
    svg += '<path d="M 50 0 L 0 0 0 50" fill="none" stroke="#e0e0e0" stroke-width="1"/></pattern></defs>';
    svg += '<rect width="' + width + '" height="' + height + '" fill="url(#grid)"/>';
    // Draw connecting lines between consecutive cones (dotted lines only, no labels)
    for (let i = 0; i < conePositions.length - 1; i++) {
        const p1 = conePositions[i];
        const p2 = conePositions[i + 1];
        svg += '<line x1="' + p1.x + '" y1="' + p1.y + '" x2="' + p2.x + '" y2="' + p2.y + '" stroke="#2196F3" stroke-width="2" stroke-dasharray="5,5" opacity="0.5"/>';
    }
    conePositions.forEach((pos, idx) => {
        const isStart = idx === 0;
        const color = isStart ? '#4CAF50' : '#FF9800';
        const label = isStart ? 'S' : idx;
        svg += '<g class="cone-group" data-idx="' + idx + '" style="cursor:grab;">';
        svg += '<circle cx="' + pos.x + '" cy="' + pos.y + '" r="25" fill="white" stroke="' + color + '" stroke-width="3"/>';
        svg += '<text x="' + pos.x + '" y="' + (pos.y + 6) + '" text-anchor="middle" font-size="18" font-weight="bold" fill="' + color + '" pointer-events="none">' + label + '</text>';
        svg += '</g>';

        const circleRadius = 25;
        const arrowLen = 30;
        const angle = pos.arrowAngle * Math.PI / 180;

        const arrowStartX = pos.x + Math.cos(angle) * circleRadius;
        const arrowStartY = pos.y + Math.sin(angle) * circleRadius;
        const arrowEndX = pos.x + Math.cos(angle) * (circleRadius + arrowLen);
        const arrowEndY = pos.y + Math.sin(angle) * (circleRadius + arrowLen);

        const arrowHeadLen = 15;
        const arrowHeadWidth = Math.PI/5;
        const arrowHead1X = arrowEndX - arrowHeadLen * Math.cos(angle - arrowHeadWidth);
        const arrowHead1Y = arrowEndY - arrowHeadLen * Math.sin(angle - arrowHeadWidth);
        const arrowHead2X = arrowEndX - arrowHeadLen * Math.cos(angle + arrowHeadWidth);
        const arrowHead2Y = arrowEndY - arrowHeadLen * Math.sin(angle + arrowHeadWidth);

        svg += '<g class="arrow-group" data-idx="' + idx + '" style="cursor:pointer;">';
        svg += '<line x1="' + arrowStartX + '" y1="' + arrowStartY + '" x2="' + arrowEndX + '" y2="' + arrowEndY + '" stroke="' + color + '" stroke-width="4"/>';
        svg += '<polygon points="' + arrowEndX + ',' + arrowEndY + ' ' + arrowHead1X + ',' + arrowHead1Y + ' ' + arrowHead2X + ',' + arrowHead2Y + '" fill="' + color + '"/>';
        svg += '</g>';

        // Add action/distance label along the arrow direction
        if (idx < devices.length) {
            const distance = devices[idx].distance || 0;
            const action = devices[idx].action || 'default_beep';
            const labelText = showActions ? action.replace(/_/g, ' ') : distance + ' ' + distanceUnit;
            const boxWidth = showActions ? 120 : 80;

            // Position label beyond arrow tip with extra spacing
            const labelDistance = arrowLen + 45;
            const labelX = pos.x + Math.cos(angle) * (circleRadius + labelDistance);
            const labelY = pos.y + Math.sin(angle) * (circleRadius + labelDistance);

            svg += '<rect x="' + (labelX - boxWidth/2) + '" y="' + (labelY - 10) + '" width="' + boxWidth + '" height="20" fill="white" stroke="' + (showActions ? '#E91E63' : '#2196F3') + '" rx="3"/>';
            svg += '<text x="' + labelX + '" y="' + (labelY + 5) + '" text-anchor="middle" font-size="12" font-weight="bold" fill="' + (showActions ? '#E91E63' : '#2196F3') + '">' + labelText + '</text>';
        }
    });
    svg += '</svg>';
    courseDiagram = svg;
    document.getElementById('diagramPreview').innerHTML = svg;
    setupDragging();
}

function setupDragging() {
    svgElement = document.getElementById('courseSvg');
    if (!svgElement) return;
    const newSvg = svgElement.cloneNode(true);
    svgElement.parentNode.replaceChild(newSvg, svgElement);
    svgElement = newSvg;

    // Prevent default touch behavior on the SVG to avoid page scrolling
    svgElement.addEventListener('touchstart', (e) => {
        e.preventDefault();
    }, { passive: false });

    svgElement.addEventListener('touchmove', (e) => {
        e.preventDefault();
    }, { passive: false });

    // Unified function to handle both mouse and touch positioning
    function getCoordinates(e) {
        const rect = svgElement.getBoundingClientRect();
        const scaleX = svgElement.viewBox.baseVal.width / rect.width;
        const scaleY = svgElement.viewBox.baseVal.height / rect.height;

        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
            // Touch event
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            // Mouse event
            clientX = e.clientX;
            clientY = e.clientY;
        }

        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    // Click/tap handler for selecting cones and rotating arrows
    function handleClickOrTap(e) {
        const coneGroup = e.target.closest('.cone-group');
        if (coneGroup) {
            const idx = parseInt(coneGroup.dataset.idx);
            if (rotateMode) {
                conePositions[idx].arrowAngle = (conePositions[idx].arrowAngle + 45) % 360;
                generateDiagram();
                return;
            }
            if (dragState === null) {
                dragState = idx;
                svgElement.style.cursor = 'grabbing';
            } else if (dragState === idx) {
                dragState = null;
                svgElement.style.cursor = 'default';
            } else {
                dragState = idx;
            }
            return;
        }
        const arrowGroup = e.target.closest('.arrow-group');
        if (arrowGroup && !rotateMode && dragState === null) {
            const idx = parseInt(arrowGroup.dataset.idx);
            conePositions[idx].arrowAngle = (conePositions[idx].arrowAngle + 45) % 360;
            generateDiagram();
            return;
        }
        if (dragState !== null) {
            dragState = null;
            svgElement.style.cursor = 'default';
        }
    }

    // Move handler for dragging cones
    function handleMove(e) {
        if (dragState !== null && !rotateMode) {
            const coords = getCoordinates(e);
            const padding = 30;
            const maxX = svgElement.viewBox.baseVal.width - padding;
            const maxY = svgElement.viewBox.baseVal.height - padding;
            conePositions[dragState].x = Math.max(padding, Math.min(maxX, coords.x));
            conePositions[dragState].y = Math.max(padding, Math.min(maxY, coords.y));
            generateDiagram();
        }
    }

    // Mouse events
    svgElement.addEventListener('click', handleClickOrTap);
    svgElement.addEventListener('mousemove', handleMove);

    // Touch events
    svgElement.addEventListener('touchstart', handleClickOrTap);
    svgElement.addEventListener('touchmove', handleMove);
    svgElement.addEventListener('touchend', () => {
        if (dragState !== null) {
            dragState = null;
            svgElement.style.cursor = 'default';
        }
    });
}

// ==================== ADVANCED SETTINGS FUNCTIONS ====================

function updateModeDescription() {
    const mode = document.getElementById('courseModeSelect').value;
    const descEl = document.getElementById('modeDescription');
    const behaviorSection = document.getElementById('behaviorConfigSection');

    if (mode === 'pattern') {
        descEl.className = 'alert alert-warning';
        descEl.innerHTML = '<strong>Pattern Mode:</strong> Athletes must follow custom rules (e.g., touch cones in a specific color sequence). Requires behavior configuration below.';
        behaviorSection.style.display = 'block';
    } else {
        descEl.className = 'alert alert-info';
        descEl.innerHTML = '<strong>Sequential Mode:</strong> Athletes touch devices in the defined order (1 ‚Üí 2 ‚Üí 3...). This is the standard mode for most drills.';
        behaviorSection.style.display = 'none';
    }
}

function validateJSON() {
    const behaviorConfig = document.getElementById('behaviorConfig').value.trim();
    const validationDiv = document.getElementById('jsonValidation');
    const validationText = document.getElementById('jsonValidationText');

    if (!behaviorConfig) {
        validationDiv.style.display = 'none';
        return true;
    }

    try {
        JSON.parse(behaviorConfig);
        validationDiv.style.display = 'block';
        validationDiv.style.backgroundColor = '#d4edda';
        validationDiv.style.color = '#155724';
        validationText.innerHTML = '‚úì Valid JSON format';
        return true;
    } catch (e) {
        validationDiv.style.display = 'block';
        validationDiv.style.backgroundColor = '#f8d7da';
        validationDiv.style.color = '#721c24';
        validationText.innerHTML = '‚úó Invalid JSON: ' + e.message;
        return false;
    }
}

// ==================== SAVE COURSE FUNCTION ====================

async function saveCourse() {
    console.log('üíæ SAVE COURSE - v5');
    
    const name = document.getElementById('courseName').value.trim();
    if (!name) {
        alert('Please enter a course name');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.getElementById('courseName').focus();
        return;
    }
    
    if (devices.length < 2) {
        alert('Add at least 2 devices (Start + 1 cone)');
        document.getElementById('section-1').classList.add('expanded');
        return;
    }

    // Get advanced settings
    const selectedMode = document.getElementById('courseModeSelect').value;
    const behaviorConfigRaw = document.getElementById('behaviorConfig').value.trim();

    // Validate behavior config if pattern mode
    if (selectedMode === 'pattern' && !behaviorConfigRaw) {
        alert('Pattern mode requires behavior configuration. Please add JSON config in Advanced Settings.');
        document.getElementById('section-4').classList.add('expanded');
        return;
    }

    // Validate JSON if provided
    if (behaviorConfigRaw && !validateJSON()) {
        alert('Invalid JSON in behavior configuration. Please fix errors before saving.');
        document.getElementById('section-4').classList.add('expanded');
        return;
    }

    let behaviorConfig = null;
    if (behaviorConfigRaw) {
        try {
            behaviorConfig = JSON.parse(behaviorConfigRaw);
        } catch (e) {
            alert('Invalid JSON in behavior configuration: ' + e.message);
            return;
        }
    }

    const saveData = {
        course_name: name,
        description: document.getElementById('courseDescription').value,
        category: document.getElementById('courseCategory').value,
        instruction: document.getElementById('courseInstruction').value,
        distance_unit: document.getElementById('distanceUnit').value,
        num_devices: devices.length,
        diagram_svg: courseDiagram || '',
        mode: selectedMode,
        course_id: courseData?.course_id || null,
        stations: devices.map((d, i) => ({
            sequence: i,
            device_id: d.device_id,
            device_name: d.device_name,
            action: d.action,
            instruction: d.instruction,
            distance: d.distance,
            device_function: d.device_function || null,
            detection_method: d.detection_method || null,
            group_identifier: d.group_identifier || null,
            behavior_config: d.behavior_config || (behaviorConfig ? JSON.stringify(behaviorConfig) : null)
        }))
    };
    
    console.log('Saving:', saveData);
    
    try {
        const res = await fetch('/api/courses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(saveData)
        });
        
        const result = await res.json();
        
        if (result.success) {
            alert('‚úÖ Course saved successfully!');
            window.location.href = '/courses';
        } else {
            alert('‚ùå Error: ' + (result.error || 'Unknown error'));
        }
    } catch (e) {
        alert('‚ùå Save failed: ' + e.message);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    if (availableDevices.length === 0) {
        loadAvailableDevices();
    }

    if (devices.length > 0) {
        renderDevices();
    }

    // Add real-time JSON validation for behavior config
    const behaviorConfigField = document.getElementById('behaviorConfig');
    if (behaviorConfigField) {
        behaviorConfigField.addEventListener('input', validateJSON);
    }
});
</script>
{% endblock %}
